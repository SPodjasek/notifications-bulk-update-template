name: Mark notifications for closed PRs as done

on:
  workflow_dispatch:

jobs:
  mark:
    name: Mark notifications for closed PRs as done
    runs-on: ubuntu-latest

    steps:
      - name: Mark notifications for closed PRs as done
        uses: actions/github-script@v7
        id: mark-closed-done
        with:
          github-token: ${{ secrets.GH_TOKEN }} 
          script: |-
            github
              .paginate("GET /notifications")
              .then((notifications) =>
                Promise.all(
                  notifications
                    .map((notification) =>
                      notification.subject.type === "PullRequest"
                        ? (async () => {
                            const { data: pr } = await github.request(
                              `GET ${new URL(notification.subject.url).pathname}`
                            );
                            if (pr.state === "closed") {
                              await github.request(
                                "DELETE /notifications/threads/{thread_id}",
                                {
                                  thread_id: notification.id,
                                }
                              );

                              return true;
                            }

                            return false;
                          })()
                        : undefined
                    )
                    .filter((promise) => promise !== undefined)
                )
              )
              .then((done) =>
                core.summary.addRaw(
                  `Marked ${done.filter((v) => !!v).length} notifications as done`, 
                  true
                )
                .write()
              );
